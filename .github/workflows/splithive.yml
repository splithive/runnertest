name: macOS Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-mac:
    runs-on: splithive
    name: macOS Tests
    concurrency: 
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
    - uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "ğŸ–¥ï¸ macOS Version:"
        sw_vers
        
        echo "\nğŸƒâ€â™‚ï¸ Runner Info:"
        uname -a
        
        echo "\nğŸ’» CPU Info:"
        sysctl -n machdep.cpu.brand_string
        system_profiler SPHardwareDataType
        
        echo "\nğŸ§® Memory Info:"
        top -l 1 | grep PhysMem
        vm_stat
        
        echo "\nğŸ’½ Disk Space:"
        df -h /
        diskutil list

    - name: Development Tools
      run: |
        echo "ğŸ“¦ Homebrew Status:"
        which brew || echo "Homebrew not installed"
        brew --version || echo "Homebrew not installed"
        
        echo "\nğŸ Python Environment:"
        which python3
        python3 --version
        pip3 list
        
        echo "\nâš™ï¸ Git Configuration:"
        git --version
        git config --list
        
        echo "\nğŸ”¨ Xcode Tools:"
        xcode-select -p || echo "Xcode tools not installed"
        xcrun --version || echo "xcrun not available"
        
        echo "\nğŸ› ï¸ Compiler Versions:"
        gcc --version || echo "GCC not installed"
        clang --version || echo "Clang not installed"

    - name: Network Tests
      run: |
        echo "ğŸŒ Network Interfaces:"
        ifconfig
        
        echo "\nğŸ”Œ Network Status:"
        networksetup -listallhardwareports
        
        echo "\nğŸ“¡ Wireless Info:"
        /System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport -I || echo "Airport command not available"
        
        echo "\nğŸŒ Connectivity Tests:"
        ping -c 4 github.com
        curl -I https://github.com
        
        echo "\nğŸ” DNS Resolution:"
        dig github.com +short
        scutil --dns
        
        echo "\nğŸŒ Public IP:"
        curl -s https://api.ipify.org
        
        echo "\nğŸ”’ SSL/TLS Support:"
        openssl version

    - name: File System Tests
      run: |
        echo "ğŸ“ Basic File Operations:"
        echo "Hello from macOS!" > test.txt
        cat test.txt
        mkdir -p test/nested/deep
        touch test/nested/deep/file.txt
        
        echo "\nğŸ“‚ File Permissions:"
        ls -la
        umask
        
        echo "\nğŸ” File Search:"
        find test -type f
        
        echo "\nğŸ’¾ File System Info:"
        mount
        
        echo "\nğŸ“Š File System Usage:"
        du -sh test

    - name: Process Management
      run: |
        echo "âš¡ Active Processes:"
        ps aux | head -5
        
        echo "\nğŸ” Resource Usage:"
        top -l 1 -n 5 -stats pid,command,cpu,mem
        
        echo "\nğŸ’» System Load:"
        sysctl vm.loadavg
        
        echo "\nğŸ§µ Thread Count:"
        ps -M $$ | wc -l

    - name: Environment & Security
      run: |
        echo "ğŸŒ³ Environment Variables:"
        env | sort
        
        echo "\nğŸ‘¤ User Information:"
        id
        groups
        
        echo "\nğŸ” Security Settings:"
        csrutil status || echo "SIP status not available"
        
        echo "\nğŸ”’ Keychain Access:"
        security list-keychains
        
        echo "\nğŸ“ Working Directory:"
        pwd
        ls -la

    - name: Performance Tests
      run: |
        echo "âš¡ Disk Speed Test:"
        dd if=/dev/zero of=speedtest bs=1024k count=1024 conv=fdatasync
        rm speedtest
        
        echo "\nğŸ§® CPU Performance:"
        python3 -c "import time; st=time.time(); [x**2 for x in range(1000000)]; print(f'Time: {time.time()-st:.2f}s')"
        
        echo "\nğŸ’¾ Memory Speed:"
        vm_stat 1 5

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        rm -rf test test.txt
        echo "âœ¨ Cleanup complete"
        
        echo "\nğŸ“Š Final System Status:"
        top -l 1 -n 0
        df -h /
